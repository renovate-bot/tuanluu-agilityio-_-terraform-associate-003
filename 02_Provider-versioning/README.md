# 02_Provider-versioning

## 📖 Overview

This module demonstrates Terraform provider versioning concepts and best practices. It showcases how to manage provider versions, understand version constraints, and handle provider dependencies in real-world scenarios using both the Random and AWS providers.

## 🎯 Learning Objectives

By completing this module, you will learn:

- **Provider Version Constraints**: How to specify and manage provider versions
- **Version Syntax**: Understanding semantic versioning and constraint operators
- **Provider Dependencies**: Managing multiple providers with different version requirements
- **Lock Files**: Understanding and using `.terraform.lock.hcl` for reproducible builds
- **Best Practices**: Version pinning strategies for different environments
- **Troubleshooting**: Resolving common provider version conflicts

## 🏗️ Infrastructure Components

This module creates the following resources:

| Resource Type | Name | Description | Provider |
|---------------|------|-------------|----------|
| `random_pet` | `petname` | Generates a random pet name for bucket naming | Random |
| `aws_s3_bucket` | `sample` | Creates an S3 bucket with the generated name | AWS |

### Architecture Diagram

```
┌─────────────────────────────────────────┐
│              AWS Cloud                  │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │          S3 Bucket              │    │
│  │                                 │    │
│  │  Name: <random-pet-name>        │    │
│  │  Region: us-west-2              │    │
│  │  Tags: public_bucket = false    │    │
│  │                                 │    │
│  └─────────────────────────────────┘    │
│                                         │
└─────────────────────────────────────────┘
              ↑
    Generated by Random Provider
┌─────────────────────────────────────────┐
│         Random Pet Generator            │
│                                         │
│  Length: 5 words                        │
│  Separator: "-"                         │
│  Example: happy-lucky-cat-dog-fish      │
│                                         │
└─────────────────────────────────────────┘
```

## 📋 Prerequisites

Before running this module, ensure you have:

- **Terraform** installed (>= 1.2)
- **AWS CLI** configured with valid credentials
- **AWS Account** with S3 permissions
- **Internet connection** for provider downloads

### Verify Prerequisites

```bash
# Check Terraform version
terraform version

# Check AWS CLI configuration
aws configure list

# Test AWS connectivity
aws sts get-caller-identity
```

## 🔧 Provider Version Configuration

### Version Constraint Syntax

```hcl
terraform {
  required_providers {
    random = {
      source  = "hashicorp/random"
      version = "3.3.2"              # Exact version
    }

    aws = {
      source  = "hashicorp/aws"
      version = ">= 4.5.0"           # Minimum version
    }
  }

  required_version = "~> 1.2"        # Terraform version constraint
}
```

### Version Constraint Operators

| Operator | Description | Example | Meaning |
|----------|-------------|---------|---------|
| `=` | Exact version | `= 3.3.2` | Only version 3.3.2 |
| `>=` | Minimum version | `>= 4.5.0` | Version 4.5.0 or higher |
| `<=` | Maximum version | `<= 4.10.0` | Version 4.10.0 or lower |
| `~>` | Pessimistic constraint | `~> 4.5` | >= 4.5.0, < 5.0.0 |
| `!=` | Exclude version | `!= 4.6.0` | Any version except 4.6.0 |

### Recommended Versioning Strategies

#### 🔒 **Production Environment**
```hcl
# Pin exact versions for stability
version = "3.3.2"
```

#### 🚀 **Development Environment**
```hcl
# Allow patch updates
version = "~> 3.3.0"
```

#### 🧪 **Testing Environment**
```hcl
# Allow minor updates
version = "~> 3.3"
```

## 🚀 Quick Start

### 1. Navigate to Module Directory

```bash
cd 02_Provider-versioning
```

### 2. Configure AWS Credentials

```bash
# Option 1: AWS CLI
aws configure

# Option 2: Environment Variables
set AWS_ACCESS_KEY_ID=your-access-key
set AWS_SECRET_ACCESS_KEY=your-secret-key
set AWS_DEFAULT_REGION=us-west-2
```

### 3. Initialize Terraform

```bash
terraform init
```

**Expected Output:**
```
Initializing the backend...
Initializing provider plugins...
- Finding hashicorp/random versions matching "3.3.2"...
- Finding hashicorp/aws versions matching ">= 4.5.0"...
- Installing hashicorp/random v3.3.2...
- Installing hashicorp/aws v4.67.0...

Terraform has been successfully initialized!
```

### 4. Review the Execution Plan

```bash
terraform plan
```

### 5. Apply the Configuration

```bash
terraform apply
```

### 6. Verify Resources

```bash
# List S3 buckets
aws s3 ls

# Check bucket details
aws s3api head-bucket --bucket <generated-bucket-name>
```

### 7. Clean Up Resources

```bash
terraform destroy
```

## 📁 File Structure

```
02_Provider-versioning/
├── terraform.tf           # Provider requirements and versions
├── main.tf               # Resource configurations
├── .terraform.lock.hcl   # Provider dependency lock file
├── terraform.tfstate     # State file (auto-generated)
├── .terraform/           # Provider plugins (auto-generated)
│   └── providers/
└── README.md             # This documentation
```

## 🔍 Understanding Provider Versioning

### Dependency Lock File (`.terraform.lock.hcl`)

The lock file ensures reproducible builds by recording:
- **Exact provider versions** used
- **Provider hashes** for security verification
- **Platform compatibility** information

```hcl
# Example content of .terraform.lock.hcl
provider "registry.terraform.io/hashicorp/aws" {
  version     = "4.67.0"
  constraints = ">= 4.5.0"
  hashes = [
    "h1:dCRc4GqsyfqHEMjgtlM1EympBcgTmcTkWaJmtd91+KA=",
    # ... more hashes
  ]
}
```

### Version Resolution Process

1. **Check constraints** in `terraform.tf`
2. **Consult lock file** for previously resolved versions
3. **Download providers** if not cached locally
4. **Verify hashes** for security
5. **Initialize providers** for use

## 🛠️ Common Commands

| Command | Purpose | Example |
|---------|---------|---------|
| `terraform init` | Initialize and download providers | `terraform init` |
| `terraform init -upgrade` | Update providers within constraints | `terraform init -upgrade` |
| `terraform providers` | List required providers | `terraform providers` |
| `terraform version` | Show Terraform and provider versions | `terraform version` |
| `terraform providers lock` | Generate lock file entries | `terraform providers lock -platform=windows_amd64` |

## 🔧 Troubleshooting

### Common Issues and Solutions

#### 1. **Provider Registry Connection Issues**

**Error:** `Failed to query available provider packages`

**Solutions:**
```bash
# Check internet connectivity
ping registry.terraform.io

# Configure proxy if needed
set HTTPS_PROXY=http://proxy.company.com:8080
set HTTP_PROXY=http://proxy.company.com:8080

# Use alternative registry mirror
terraform init -plugin-dir=./plugins

# Retry with debug logging
set TF_LOG=DEBUG
terraform init
```

#### 2. **Version Constraint Conflicts**

**Error:** `No available releases match the given constraints`

**Solutions:**
```bash
# Check available versions
terraform init -upgrade

# Relax version constraints temporarily
# Change: version = "= 3.3.2"
# To:     version = ">= 3.3.0"

# Clear provider cache
rmdir /s .terraform
terraform init
```

#### 3. **AWS Authentication Issues**

**Error:** `NoCredentialsError: Unable to locate credentials`

**Solutions:**
```bash
# Verify AWS configuration
aws configure list

# Check environment variables
echo %AWS_ACCESS_KEY_ID%
echo %AWS_SECRET_ACCESS_KEY%

# Test AWS connectivity
aws sts get-caller-identity

# Use AWS profile
set AWS_PROFILE=your-profile-name
```

#### 4. **Lock File Platform Issues**

**Error:** `Platform not supported`

**Solutions:**
```bash
# Generate lock file for current platform
terraform providers lock -platform=windows_amd64

# Generate for multiple platforms
terraform providers lock -platform=windows_amd64 -platform=linux_amd64 -platform=darwin_amd64
```

### Debugging Commands

```bash
# Enable debug logging
set TF_LOG=DEBUG
set TF_LOG_PATH=terraform.log

# Check provider installation directory
dir .terraform\providers

# Validate configuration
terraform validate

# Check provider requirements
terraform providers

# Show detailed version information
terraform version -json
```

## 🎓 Advanced Topics

### 1. **Provider Aliases**

```hcl
provider "aws" {
  alias  = "us_east"
  region = "us-east-1"
}

provider "aws" {
  alias  = "us_west"
  region = "us-west-2"
}

resource "aws_s3_bucket" "east_bucket" {
  provider = aws.us_east
  bucket   = "my-east-bucket"
}
```

### 2. **Provider Configuration Blocks**

```hcl
terraform {
  required_providers {
    aws = {
      source                = "hashicorp/aws"
      version              = ">= 4.5.0"
      configuration_aliases = [aws.us_east, aws.us_west]
    }
  }
}
```

### 3. **Provider Version Lifecycle**

```hcl
# Development: Allow patch updates
version = "~> 4.67.0"  # 4.67.0 <= version < 4.68.0

# Staging: Pin to minor version
version = "~> 4.67"    # 4.67.0 <= version < 5.0.0

# Production: Pin exact version
version = "= 4.67.0"   # Exactly 4.67.0
```

## 💡 Best Practices

### 🔒 **Security**
- Always use version constraints to prevent unexpected updates
- Commit `.terraform.lock.hcl` to version control
- Regularly review and update provider versions
- Use exact versions in production environments

### 📦 **Version Management**
- Pin exact versions for critical production workloads
- Use pessimistic constraints (`~>`) for development
- Test provider updates in non-production environments first
- Document version update procedures

### 🏗️ **Infrastructure Management**
- Keep provider versions consistent across environments
- Use Terraform Cloud/Enterprise for centralized version management
- Automate provider version checking in CI/CD pipelines
- Maintain a provider version upgrade schedule

## 📚 Additional Resources

### Provider Documentation
- [Terraform Provider Requirements](https://www.terraform.io/docs/configuration/provider-requirements.html)
- [AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [Random Provider Documentation](https://registry.terraform.io/providers/hashicorp/random/latest/docs)

### Version Management
- [Semantic Versioning](https://semver.org/)
- [Terraform Version Constraints](https://www.terraform.io/docs/configuration/version-constraints.html)
- [Provider Version Configuration](https://www.terraform.io/docs/configuration/provider-requirements.html#version-constraints)

### Troubleshooting
- [Provider Installation](https://www.terraform.io/docs/cli/config/config-file.html#provider-installation)
- [Network Connectivity](https://www.terraform.io/docs/cli/config/config-file.html#network-mirror-protocol)
- [Provider Plugin Cache](https://www.terraform.io/docs/cli/config/config-file.html#provider-plugin-cache)

## 🎯 Next Steps

After completing this module, consider:

1. **Experiment with different version constraints**
2. **Set up a provider mirror for offline usage**
3. **Create a multi-region AWS deployment**
4. **Implement provider version automation**
5. **Explore Terraform Cloud for centralized management**

## 💡 Pro Tips

1. **Always commit** `.terraform.lock.hcl` to ensure reproducible builds
2. **Use exact versions** in production to prevent unexpected changes
3. **Test provider updates** in lower environments before production
4. **Monitor provider changelogs** for breaking changes
5. **Use Terraform workspaces** to manage different version strategies
6. **Set up automated alerts** for new provider versions

---

**Happy Learning!** 🎉

*This module is part of the Terraform Associate 003 learning project.*